       1                                ;
       2                                ; very simple RL02 controller diagnostic
       3                                ; check register access and basic commands
       4                                ; brad@heeltoe.com 1/2011
       5                                ;
       6                                	.TITLE rltest
       7                                	.ASECT
       8                                
       9 174400                         RLCS= 174400		;RL02
      10 174402                         RLBA= 174402
      11 174404                         RLDA= 174404
      12 174406                         RLMP= 174406
      13                                
      14 177560                         TKS= 177560		;TTY KBD STATUS
      15 177562                         TKB= 177562		;TTY KBD BUFFER
      16 177564                         TPS= 177564		;TTY PRINTER STATUS REG. ADDRESS
      17 177566                         TPB= 177566		;TTY PRINTER BUFFER REG. ADDRESS
      18                                
      19                                ;
      20                                ; boot sector - read in reset of code (bootstrap reads 0-777)
      21                                ;
      22 000000                         	.=0
      23                                boot:
      24 000000 012700  174400          	mov #RLCS,r0
      25 000004 012760  001000  000002  	mov #1000,2(r0)		; ba = 1000
      26 000012 012760  000002  000004  	mov #2,4(r0)		; da = 1
      27 000020 012760  170000  000006  	mov #-4096.,6(r0)	; set wc
      28 000026 012710  000014          	mov #14,(r0)		; read
      29                                
      30 000032 105710                  	tstb (r0)		; wait
      31 000034 100376                  	bpl .-2
      32                                
      33 000036 032710  100000          	bit #100000,(r0)
      34 000042 001401                  	beq ok
      35 000044 000000                  	halt
      36                                ok:
      37 000046 000137  000402          	jmp @#start
      38                                
      39                                ; -------------------------------------------------------------
      40                                
      41                                ;
      42                                ; code from disk...
      43                                ;	
      44 000400                         	.=400
      45 000400 000400                  	br	start
      46                                
      47                                start:
      48 000402 012706  010000          	mov	#10000,sp
      49 000406 004737  000616          	jsr	pc,@#type
      50 000412 000506                  	.word	shdr
      51                                
      52 000414 012705  000003          	mov	#3,r5
      53                                loop:
      54 000420 004737  000616          	jsr	pc,@#type
      55 000424 000532                  	.word	sline
      56 000426 004767  000676'         	jsr	pc,chkrg
      57 000432 004767  001224'         	jsr	pc,chksk
      58 000436 004767  001274'         	jsr	pc,chkrd
      59                                
      60 000442 004767  000676'         	jsr	pc,chkrg
      61 000446 004767  001224'         	jsr	pc,chksk
      62 000452 004767  001274'         	jsr	pc,chkrd
      63                                
      64 000456 005305                  	dec	r5
      65 000460 001357                  	bne	loop
      66                                
      67                                done:
      68 000462 004737  000616          	jsr	pc,@#type
      69 000466 000517                  	.word	sdone
      70 000470 004737  000476          	jsr	pc,@#crlf
      71 000474 000000                  	halt
      72                                
      73                                crlf:
      74 000476 004737  000616          	jsr	pc,@#type
      75 000502 000527                  	.word	scrlf
      76 000504 000207                  	rts	pc
      77                                
      78                                ; -------------------------------------------------------------
      79                                
      80                                shdr:
      81 000506    015     012          	.ascii	<15><12>
      82 000510    163     164     141  	.asciz	/start!/
         000513    162     164     041  
         000516    000                  
      83                                
      84                                sdone:
      85 000517    015     012          	.ascii	<15><12>
      86 000521    144     157     156  	.asciz	/done./	
         000524    145     056     000  
      87                                
      88                                scrlf:
      89 000527    015                  	.ascii	<15>
      90 000530    012     000          	.asciz	<12>
      91                                
      92 000532    015     012          sline:	.ascii	<15><12>
      93 000534    055     055     055  	.asciz  /------------------------/
         000537    055     055     055  
         000542    055     055     055  
         000545    055     055     055  
         000550    055     055     055  
         000553    055     055     055  
         000556    055     055     055  
         000561    055     055     055  
         000564    000                  
      94                                
      95                                
      96                                schkrg:
      97 000565    015     012          	.ascii	<15><12>
      98 000567    162     145     147  	.asciz	/regs:/	
         000572    163     072     000  
      99                                schksk:
     100 000575    015     012          	.ascii	<15><12>
     101 000577    163     145     145  	.asciz	/seek:/	
         000602    153     072     000  
     102                                schkrd:
     103 000605    015     012          	.ascii	<15><12>
     104 000607    162     145     141  	.asciz	/read:/	
         000612    144     072     000  
     105                                
     106                                ;
     107 000615    000                  	.even
     108                                type:
     109 000616 010046                  	mov	r0,-(sp)	; save r0
     110 000620 017600  000002          	mov	@2(sp),r0
     111 000624 112046                  2$:	movb	(r0)+,-(sp)	; push char
     112 000626 001404                  	beq	4$		; done?
     113 000630 004737  000652          	jsr	pc,@#typec
     114 000634 005726                  	tst	(sp)+		; pop char
     115 000636 000772                  	br	2$
     116                                4$:
     117 000640 005726                  	tst	(sp)+		; pop char
     118 000642 012600                  	mov	(sp)+,r0	; restore r0
     119 000644 062716  000002          	add	#2,(sp)
     120 000650 000207                  	rts	pc
     121                                
     122                                ;
     123                                typec:
     124 000652 105737  177564          	tstb	@#TPS
     125 000656 100375                  	bpl	typec	
     126 000660 116637  000002  177566  	movb	2(sp),@#TPB
     127                                ;
     128 000666 105737  177564          1$:	tstb	@#TPS
     129 000672 100375                  	bpl	1$
     130                                ;
     131 000674 000207                  	rts	pc
     132                                
     133                                ; -------------------------------------------------------------
     134                                
     135                                ;
     136                                ; regs 
     137                                ;
     138                                chkrg:
     139 000676 004737  000616          	jsr	pc,@#type
     140 000702 000565                  	.word	schkrg
     141 000704 004767  000732'         	jsr	pc,chkrw0		; check reg read/write
     142 000710 004767  001020'         	jsr	pc,chkrw1
     143 000714 004767  001056'         	jsr	pc,chkrw2
     144 000720 004767  001116'         	jsr	pc,chkrw3
     145 000724 004767  001162'         	jsr	pc,chkcs1		; check cs tstb reads in loop
     146 000730 000207                  	rts pc
     147                                
     148                                ;
     149                                ; read/write register
     150                                ;
     151                                chkrw0:
     152 000732 012700  174404          	mov #RLDA,r0
     153 000736 012702  000000          	mov #0,r2
     154 000742 011001                  	mov (r0), r1
     155 000744 010210                  	mov r2,(r0)
     156 000746 011001                  	mov (r0), r1
     157 000750 020102                  	cmp r1,r2
     158 000752 001401                  	beq 1$
     159 000754 000000                  	halt
     160                                1$:
     161 000756 012702  177777          	mov #177777,r2
     162 000762 011001                  	mov (r0), r1
     163 000764 010210                  	mov r2,(r0)
     164 000766 011001                  	mov (r0), r1
     165 000770 020102                  	cmp r1,r2
     166 000772 001401                  	beq 2$
     167 000774 000000                  	halt
     168                                2$:
     169 000776 012702  001234          	mov #1234,r2
     170 001002 011001                  	mov (r0), r1
     171 001004 010210                  	mov r2,(r0)
     172 001006 011001                  	mov (r0), r1
     173 001010 020102                  	cmp r1,r2
     174 001012 001401                  	beq 3$
     175 001014 000000                  	halt
     176                                3$:
     177 001016 000207                  	rts pc
     178                                
     179                                ;
     180                                ; inc register (r-m-w)
     181                                ;
     182                                chkrw1:
     183 001020 012700  174404          	mov #RLDA,r0
     184 001024 012702  000001          	mov #1,r2
     185 001030 011001                  	mov (r0), r1
     186 001032 010210                  	mov r2,(r0)	;1
     187 001034 005210                  	inc (r0)	;2
     188 001036 005210                  	inc (r0)	;3
     189 001040 005210                  	inc (r0)	;4
     190 001042 011003                  	mov (r0),r3
     191 001044 022703  000004          	cmp #4,r3
     192 001050 001401                  	beq 1$
     193 001052 000000                  	halt
     194                                1$:
     195 001054 000207                  	rts pc
     196                                
     197                                ;
     198                                ; bis register (r-m-w)
     199                                ;
     200                                chkrw2:
     201 001056 012700  174404          	mov #RLDA,r0
     202 001062 011001                  	mov (r0), r1
     203 001064 005010                  	clr (r0)	;000
     204 001066 052710  000010          	bis #10,(r0)	;010
     205 001072 052710  000020          	bis #20,(r0)	;030
     206 001076 052710  000001          	bis #01,(r0)	;031
     207 001102 011003                  	mov (r0),r3
     208 001104 022703  000031          	cmp #31,r3
     209 001110 001401                  	beq 1$
     210 001112 000000                  	halt
     211                                1$:
     212 001114 000207                  	rts pc
     213                                
     214                                ;
     215                                ; bic register (r-m-w)
     216                                ;
     217                                chkrw3:
     218 001116 012700  174404          	mov #RLDA,r0
     219 001122 012702  000777          	mov #0777,r2
     220 001126 011001                  	mov (r0), r1
     221 001130 010210                  	mov r2,(r0)	;777
     222 001132 042710  000010          	bic #10,(r0)	;767
     223 001136 042710  000020          	bic #20,(r0)	;747
     224 001142 042710  000001          	bic #01,(r0)	;746
     225 001146 011003                  	mov (r0),r3
     226 001150 022703  000746          	cmp #746,r3
     227 001154 001401                  	beq 1$
     228 001156 000000                  	halt
     229                                1$:
     230 001160 000207                  	rts pc
     231                                
     232                                ;
     233                                ; do commmand, wait for completion while polling RLCS
     234                                ;
     235                                chkcs1:
     236 001162 012700  174400          	mov #RLCS,r0
     237 001166 012701  000006          	mov #6,r1		; seek
     238                                ;
     239 001172 012760  000000  000004  	mov #0,4(r0)		; da = 0
     240 001200 010110                  	mov r1,(r0)
     241 001202 105710                  	tstb (r0)
     242 001204 100376                  	bpl .-2
     243                                ;
     244 001206 012760  000000  000004  	mov #0,4(r0)		; again
     245 001214 010110                  	mov r1,(r0)
     246 001216 105710                  	tstb (r0)
     247 001220 100376                  	bpl .-2
     248                                
     249 001222 000207                  	rts pc
     250                                
     251                                ;
     252                                ; *** seek ***
     253                                ;
     254                                chksk:
     255 001224 004737  000616          	jsr	pc,@#type
     256 001230 000575                  	.word	schksk
     257                                
     258 001232 012700  174400          	mov #RLCS,r0
     259 001236 012701  000006          	mov #6,r1		; seek
     260                                ;
     261 001242 012760  000000  000004  	mov #0,4(r0)		; da = 0
     262 001250 010110                  	mov r1,(r0)
     263 001252 105710                  	tstb (r0)		; wait
     264 001254 100376                  	bpl .-2
     265                                ;
     266 001256 012760  000000  000004  	mov #0,4(r0)		; again
     267 001264 010110                  	mov r1,(r0)
     268 001266 105710                  	tstb (r0)
     269 001270 100376                  	bpl .-2
     270                                
     271 001272 000207                  	rts pc
     272                                
     273                                ;
     274                                ; *** read ***
     275                                ;
     276                                chkrd:
     277 001274 004737  000616          	jsr	pc,@#type
     278 001300 000605                  	.word	schkrd
     279                                
     280 001302 012700  174400          	mov #RLCS,r0
     281 001306 012760  020000  000002  	mov #20000,2(r0)	; ba = 20000
     282 001314 012760  000001  000004  	mov #1,4(r0)		; da = 1
     283 001322 012760  170000  000006  	mov #-4096.,6(r0)	; set wc
     284 001330 012710  000014          	mov #14,(r0)		; read
     285                                
     286 001334 105710                  	tstb (r0)		; wait
     287 001336 100376                  	bpl .-2
     288                                
     289 001340 032710  100000          	bit #100000,(r0)	; error?
     290 001344 001401                  	beq 1$
     291 001346 000000                  	halt
     292                                1$:
     293 001350 000207                  	rts pc
     293                                
